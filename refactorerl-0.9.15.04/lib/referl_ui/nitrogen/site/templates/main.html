<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Connection" content="keep-alive" />
<title>[[[page:title()]]]</title>
<script src='/static?file=nitrogen/jquery.js' type='text/javascript' charset='utf-8'></script>
<script src='/static?file=nitrogen/jquery-ui.js' type='text/javascript' charset='utf-8'></script>
<script src='/static?file=nitrogen/menu.js' type='text/javascript' charset='utf-8'></script>
<script src='/static?file=nitrogen/livevalidation.js' type='text/javascript' charset='utf-8'></script>
<script src='/static?file=nitrogen/nitrogen.js' type='text/javascript' charset='utf-8'></script>
<script src='/static?file=nitrogen/bert.js' type='text/javascript' charset='utf-8'></script>
<script src="/static?file=nitrogen/jquery_file_tree/jqueryFileTree.js" type="text/javascript"></script>
<script src="/static?file=nitrogen/jquery.toastmessage.js" type="text/javascript"></script>
<link href="/static?file=nitrogen/jquery_file_tree/jqueryFileTree.css" rel="stylesheet" type="text/css" media="screen" />
<link rel="stylesheet" href="/static?file=nitrogen/jquery-ui/jquery.ui.all.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="/static?file=nitrogen/nitrogen.css" type="text/css"/>
<link rel="stylesheet" href="/static?file=css/jquery-ui-1.8.13.custom.css" type="text/css"/>
<link rel="stylesheet" href="/static?file=css/style.css" type="text/css"/>

</head>
<body>
<div id="container">
<div id="header" class="wfid_pagetop">
<h1>RefactorErl</h1>
<div id="menu">
<table>
<tr style="margin:5px;">
<td id="menu_queries" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/main">Queries</a></td>
<td id="menu_files" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/files">Admin</a></td>
<td id="menu_errors" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/errors">Errors</a></td>
<td id="menu_graph" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/graphs">Dependency Graphs</a></td>
<!--<td id="menu_codedups" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/codedups">Code Duplicates</a></td> -->
<td id="menu_invs" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);"><a href="/investigations">Investigations</a></td>
<td id="menu_logout" onMouseOver="javascript:activateMenu(this);" onMouseClick="javascript:activateMenu(this);" onMouseOut="javascript:inactivateMenu(this);">[[[page:logout()]]]</td>
</tr>
<tr>
<td align="center" valign="top"><img src="images/menu.png" id="menu_queries_img" class="menu_item"/></td>
<td align="center" valign="top"><img src="images/menu.png" id="menu_files_img" class="menu_item"/></td>
<td align="center" valign="top"><img src="images/menu.png" id="menu_errors_img" class="menu_item"/></td>
<td align="center" valign="top"><img src="images/menu.png" id="menu_graph_img" class="menu_item"/></td>
<!--<td align="center" valign="top"><img src="images/menu.png" id="menu_codedups_img" class="menu_item"/></td> -->
<td align="center" valign="top"><img src="images/menu.png" id="menu_invs_img" class="menu_item"/></td>
<td align="center" valign="top"><img src="images/menu.png" id="menu_logout_img" class="menu_item"/></td>
</tr>
</table>
</div>
<div id="input">
    [[[page:query_editor()]]]
</div>
</div>
<table style="width:100%">
<tr>
<td id="tabstd" style="width:29%">
<div id="tabs">
   <ul>
      <li><a href="#queries">Queries</a></li>
      <li><a href="#last_result">Last Result</a></li>
   </ul>
<div id="queries">
<div class="need_db main_restr"></div>
<h2>Queries</h2>
[[[page:queries()]]]
</div>
<div id="last_result">
<h2>Last Result</h2>
[[[page:executed_query()]]]
[[[page:query_result()]]]
</div>
</div>
</td>
<td id="mainwrappertd" style="width:51%">
<div id="mainwrapper">
<div id="result">
<!---<h2>Query Result</h2>--->
[[[page:warnings()]]]
[[[page:query_result_source_code()]]]
</div>
</div>
</td>
<td id="filetabtd" style="width:20%">
<div id="filetab" class="ui-widget ui-widget-content ui-corner-all">
<div class="need_db main_restr2"></div>
<h2>File Browser</h2>
[[[page:browser_type_select()]]]
[[[page:file_browser()]]]
</div>
</td>
</tr>
</table>
<div id="mainfooter"><a
	href="http://plc.inf.elte.hu/erlang/dl/cheat-sheet.pdf" target="_blank">
RefactorErl Cheat-Sheet </a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a
	href="http://pnyf.inf.elte.hu/trac/refactorerl/wiki" target="_blank"> Manual </a></div>
</div>
[[[page:other()]]]
<script>
[[[script]]]

function showHideDataRow(clicked){
	var classes = clicked.attr("class").split(" ");
	var group = undefined;
	window.jQuery.each(classes, 
		function(ind,cl){
			if (/group/i.test(cl)){
				group = cl;
				return false;
			}
		});
	var target = ".data."+group;
    if($(".headtxt."+group).text()=="Hide") 
        $(".headtxt."+group).html('Show');
    else
        $(".headtxt."+group).html('Hide');
	$(target).toggle();
}

function newWindow(url){
	window.open(url);
}

function sortcolumns(column)
{
    var col1=new Array();
    var col2=new Array();
    var i=0;
    while(1)
    {
        var el=obj('metricresult1_'+i);
        if(el!=undefined) col1.push(el); else break;
        el=obj('metricresult2_'+i);
        if(el!=undefined) col2.push(el); else break;
        i++;
    }

    var j=0;
    for(i=0;i<col1.length-1;i++)
    for(j=i+1;j<col1.length;j++)
    if((column==1 && comparenames(col1[i].textContent,col1[j].textContent))
    || (column==2 && comparenames(col1[j].textContent,col1[i].textContent))
    || (column==3 && toint(col2[i].textContent)>toint(col2[j].textContent))
       || (column==4 && toint(col2[i].textContent)<toint(col2[j].textContent)))
    {
        var tmp1=col1[i];
        var tmp2=col2[i];
        col1[i]=col1[j];
        col2[i]=col2[j];
        col1[j]=tmp1;
        col2[j]=tmp2;
    }
    
    for(i=0;i<col1.length;i++)
    {   
        obj('metricresult_'+i).appendChild(col1[i]);
        obj('metricresult_'+i).appendChild(col2[i]);
    }
}

function comparenames(i,j)
{
    if(i.substring(3,7)=="Line") i=i.substring(i.indexOf(":")+2);
    if(j.substring(3,7)=="Line") j=j.substring(j.indexOf(":")+2);
    return (i>j);
}

function toint(s)
{
    var i=parseInt(s);
    if(isNaN(i)) return s; else return i;
}

var pos;
var line;
var result;
var range;

function getpos(el){
	pos=1;
	result=0;
	var selection;
	if (window.getSelection) 
		selection = window.getSelection();
	else if (document.selection)
		selection = document.selection.createRange();
	if(selection.rangeCount)
	{
		var range=selection.getRangeAt(0);
		var b=findpos(el,range,false);
		return b;
	} else return 0;
}

function findpos(el,range,tab){
    $(el).contents().each(function(i,e){
        if (e.nodeType==1 && e.tagName!="BR"){
          findpos(e,range,(e.tagName=="B"));
		  if(result!=0) return false;
        }else{
			var length;
			if(e.tagName=="BR" || tab) 
                length=1; 
            else 
                length=byteLength(e.nodeValue);
			if(e==range.startContainer)
			{
				if(!tab)
					result=pos+range.startOffset;
				else
					result=pos+1;
				return false;
			}
			else
				pos = pos+length;
        }
    });
	return result;
}

//For UTF-8 files (if needed)
function byteLength(text) {
	var escapedStr = encodeURI(text);
	var count;
	if (escapedStr.indexOf("%") != -1) {
		count = escapedStr.split("%").length - 1;
		if (count == 0) count++;
		var tmp = escapedStr.length - (count * 3);
		count = count + tmp;
        //spaces
		count = count-(escapedStr.split("%C2%A0").length-1);
        //latin coded utf-8 chars
		count = count-(escapedStr.split("%EF%BF%BD").length-1)*2; 
	} else {
		count = escapedStr.length;
	}
	return count;
}

function dig(el,range,start,end,tab){
	if (start <= 0) return;
    $(el).contents().each(function(i,e){
        if (e.nodeType==1 && e.tagName!="BR")
		{
			dig(e,range,start,end,(e.tagName=="B"));  
        }
		else
		{
			var length=0;
			if(e.tagName=="BR" || tab) 
                length=1; 
            else 
                length=byteLength(e.nodeValue);
            if (pos<start){
				if (pos+length>=start)
				{
					if(e.nodeValue==null)
						range.setStart(e, 0);
					else
			            if(tab) 
							range.setStart(e, start-pos+3); 
						else
				            range.setStart(e, start-pos);
				}
            }

            if (pos<end){
				if (pos+length>=end)
				{
					if(e.nodeValue==null)
						range.setEnd(e, 0);
					else
                		range.setEnd(e, end-pos);
					var sel = window.getSelection();
					sel.removeAllRanges();
                    document.designMode = "on";
                    sel.addRange(range);
                    var x=range.getBoundingClientRect().left;
                    if(x-$('#mainwrapper').offset().left>$('#mainwrapper').width())
                        $('#mainwrapper').scrollLeft(x-$('#mainwrapper').offset().left);
                    var y=range.getBoundingClientRect().top;
                    $('#mainwrapper').scrollTop(y-$('#mainwrapper').offset().top);
                    if (!document.execCommand("HiliteColor", false, "#FFCC66")){
                        document.execCommand("BackColor", false, "#FFCC66");
                    }
                    document.designMode = "off";
                    sel.removeAllRanges();
					throw("");
				}
            }            

            pos = pos+length;

        }
    });  
}

function highlight(element,st,en){
    unhighlight(document.getElementById('mainwrapper'));
    $('#mainwrapper').scrollTop(0);
    $('#mainwrapper').scrollLeft(0);
	pos=1;
	range = document.createRange();
    try
	{
    	dig(element,range,st,en,false);
	} catch(ex) {}   
}

function dig_lc(el,range,startl,startc,endl,endc,tab){
    $(el).contents().each(function(i,e){
        if (e.nodeType==1 && e.tagName!="BR")
		{
			dig_lc(e,range,startl,startc,endl,endc,(e.tagName=="B"));  
        }
		else
		{
			var length;
			var linestep;
			if(tab) length=1; else length=e.length;
			if(e.tagName=="BR") length=0;
			if(e.tagName=="BR") linestep=1; else linestep=0;
            if (pos<=startc && line<=startl){
				if (pos+length>=startc && line+linestep>=startl)
				{
					if(e.nodeValue==null)
						range.setStart(e, 0);
					else
			            range.setStart(e, startc-pos); 
				}
            }

            if (pos<endc && line<=endl){
				if (pos+length>=endc && line+linestep>=endl)
				{
					if(e.nodeValue==null)
						range.setEnd(e, 0);
					else
                		range.setEnd(e, endc-pos);
                    var sel = window.getSelection();
                    sel.removeAllRanges();
                    document.designMode = "on";
                    sel.addRange(range);
                    var x=range.getBoundingClientRect().left;
                    if(x-$('#mainwrapper').offset().left>$('#mainwrapper').width())
                        $('#mainwrapper').scrollLeft(x-$('#mainwrapper').offset().left);
                    var y=range.getBoundingClientRect().top;
                    $('#mainwrapper').scrollTop(y-$('#mainwrapper').offset().top);
                    if (!document.execCommand("HiliteColor", false, "#FFCC66")){
                        document.execCommand("BackColor", false, "#FFCC66");
                    }
                    document.designMode = "off";
                    sel.removeAllRanges();
					throw("");
				}
            }            

            if(linestep==1) pos=1; else pos = pos+length;
			line = line+linestep;
        }
    });  
}

function highlight_lc(element,stl,stc,endl,endc){
    unhighlight(document.getElementById('mainwrapper'));
	$('#mainwrapper').scrollTop(0);
    $('#mainwrapper').scrollLeft(0);
    pos=1;
	line=1;
	range = document.createRange();
    try{
    	dig_lc(element,range,stl,stc,endl,endc,false);
    }catch(ex){}
}

function unhighlight(node) {
    if (node.nodeType == 1) 
        node.style.backgroundColor = "";
    var child = node.firstChild;
    while (child) {
        unhighlight(child);
        child = child.nextSibling;
    }
}

function positionContextMenu(elem){
	var range = document.createRange();
	range.setStart(elem,0);
	range.setEnd(elem,1);
	var x=range.getBoundingClientRect().left;
	var y=range.getBoundingClientRect().bottom;
	var ytop=range.getBoundingClientRect().top;
	$(obj('contextmenu')).css('left',x);
	if(y+$(obj('contextmenu')).height()>window.innerHeight)
		$(obj('contextmenu')).css('top',ytop-$(obj('contextmenu')).height());
	else
		$(obj('contextmenu')).css('top',y);
	if(showcontext) 
		$(obj('contextmenu')).css('display','inline');
	else 
    {
        $(obj('contextmenu')).css('display','none'); 
		showcontext=true;
    }
}

function scrolltonode(elem){
	$('#mainwrapper').scrollTop(0);
    $('#mainwrapper').scrollLeft(0);
	range = document.createRange();
	range.setStart(elem,0);
	range.setEnd(elem,1);
    var x=range.getBoundingClientRect().left;
    if(x-$('#mainwrapper').offset().left>$('#mainwrapper').width())
        $('#mainwrapper').scrollLeft(x-$('#mainwrapper').offset().left);
	var y=range.getBoundingClientRect().top;
	$('#mainwrapper').scrollTop(y-$('#mainwrapper').offset().top);
}

function generatelinenums(text,container){
	s="";
	l=countlines(text);
	for(i=1;i<=l;i++)
		s+=i+"<br>";
	container.innerHTML=s;
}

function countlines(el){
	var sum=0;
    $(el).contents().each(function(i,e){
		if(e.tagName=="BR") sum++;
        if (e.nodeType==1) sum+=countlines(e); 	
    });
	return sum; 
}

function resizerow(tabs){
    var w=$(window).width();
    var w1=$("#tabs").css('display')=='none'?0:$("#tabs").width()+w/100;
    var w2=$("#filetab").css('display')=='none'?0:$("#filetab").width();
    var w3=w-w1-w2;
    $("#tabstd").css("width",100*(w1/w)+"%");
    $("#queries, #last_result, .main_restr").css("width",100*(w1/w)-4+"%");
    $("#mainwrappertd").css("width",100*(w3/w)+"%");
    $("#mainwrapper").css("width",100*(w3/w)-1+"%");
    $("#filetabtd").css("width",100*(w2/w)+"%");
}

/*Show file in treeview
function collapsedir(dirname)
{
	var dirs=document.getElementsByClassName('directory');
	for(var i=0;i<dirs.length;i++)
	{
		var dir=$(dirs[i]).find('A');
		if(dir.attr("rel")==dirname && $(dirs[i]).hasClass("collapsed")) 
            dir.click();
	}
}

function showfile(file)
{
	var s="";
	var dirs=file.split("/");
	for(var i=0;i<dirs.length-1;i++)
	{
		s+=dirs[i]+"/";
		collapsedir(s);
	}
}
*/

$(document).ready( function() {
$('.source_code_ta').live('select', function(){
	var tomb=document.getElementsByClassName('source_code_ta');
	var t=tomb[0];
	if (t.selectionStart!=t.selectionEnd){
		$.post("ajax_handler", { selected_position: t.selectionStart} );
	}
});
$('.source_code_ta').live('focus', function(){
	scrollToCurrent();
});

if($('.file_filter').val()=="") 
	var filter=""; 
else
	var filter='&filter='+$('.file_filter').val();

$('#file_browser_db').fileTree({
	        root: '[[[page:get_db_root_dir()]]]',
	        script: 'ajax_handler?mod=db'+filter,
	        expandSpeed: 500,
	        collapseSpeed: 500
	    },function(file){
	    	$.post("ajax_handler", { selected_file: file} );
			$(obj('show_html_button')).click();
	    });

$('.file_filter').live('keyup', function(){
	$('#file_browser_db').remove();
	$(obj('file_browser_db_panel')).append('<div id="file_browser_db"></div>');
	if($(this).val()=="")
		$('#file_browser_db').fileTree({
	        root: '[[[page:get_db_root_dir()]]]',
	        script: 'ajax_handler?mod=db',
	        expandSpeed: 500,
	        collapseSpeed: 500
	    },function(file){
	    	$.post("ajax_handler", { selected_file: file} );
			$(obj('show_html_button')).click();
	    });
	else
		$('#file_browser_db').fileTree({
	        root: '@filter',
	        script: 'ajax_handler?mod=db&filter='+$(this).val(),
	        expandSpeed: 1,
	        collapseSpeed: 1
	    },function(file){
	    	$.post("ajax_handler", { selected_file: file} );
			$(obj('show_html_button')).click();
	    });
});


$(' #mainwrapper').live('mouseup', function(e){
    $(obj('contextmenu')).css('display','none');
});

$('.monosp').live('mouseup', function(e){
    $(obj('contextmenu')).css('display','none');
    var posit=getpos(obj('query_result_source_code_placeholder'));
    var sel = window.getSelection();
	sel.removeAllRanges();
    $.post("ajax_handler", { selected_position: posit} );
    if(posit!="0")
    {
        cd.value=e.pageX+"|"+e.pageY;
        $(startfrompos).click();
    }
});

$('#mainwrapper').scroll(function(){
	if(lastcolored!=null && $(obj('contextmenu')).css('display')=='inline')
	{
		y=$(lastcolored).position().top+$('#mainwrapper').offset().top
          +$(lastcolored).height();
		if(y+$(obj('contextmenu')).height()<window.innerHeight && 
           y>$('#mainwrapper').offset().top)
		{
			$(obj('contextmenu')).css('top',y);
		} else $(obj('contextmenu')).css('top',-1000);
	}
});

$('.head').live('click',function(){
    showHideDataRow($(this));
});

$('.grouph').live('mouseenter',function(){
    var classes = $(this).attr("class").split(" ");
	var group = undefined;
	window.jQuery.each(classes, 
		function(ind,cl){
			if (/group/i.test(cl)){
				group = cl;
				return false;
			}
		});
	var target = ".groupd."+group;
	$(target).show();
});

$('.grouph').live('mouseleave',function(){
    var classes = $(this).attr("class").split(" ");
	var group = undefined;
	window.jQuery.each(classes, 
		function(ind,cl){
			if (/group/i.test(cl)){
				group = cl;
				return false;
			}
		});
	var target = ".groupd."+group;
	$(target).hide();
});

$('.groupd').live('mouseenter',function(){$(this).show()});
$('.groupd').live('mouseleave',function(){$(this).hide()});

$('#mainwrapper .mylink').live('mouseenter',function(){
	if($(this).hasClass("selectednode") 
       && $(obj('contextmenu')).css('display')=='none') 
	{		
		$(obj('contextmenu')).css('display','inline');
		y=$(lastcolored).position().top+$('#mainwrapper').offset().top
          +$(lastcolored).height();
		if(y+$(obj('contextmenu')).height()<window.innerHeight 
           && y>$('#mainwrapper').offset().top)
		{
			$(obj('contextmenu')).css('top',y);
		} else $(obj('contextmenu')).css('top',-1000);
	}
});

//$(document).bind("contextmenu",function(e){return false;}); 

tabshidden=false;
filetabhidden=false;
lastcolored=null;
lastcoloredresult=null;
selectednode=null;
cb=obj('hiddenbutton');
startfrompos=obj('hiddenbutton_startfrompos');
cd=obj('hiddendata');
showcontext=true;

$("#tabs").tabs();

$("#tabs").resizable({ handles: "e", alsoResize: "#queries, #last_result, .main_restr", stop: function(event, ui){
    var w=$(window).width();
    var w1=$("#tabs").css('display')=='none'?0:$("#tabs").width()+w/100;
    var w2=$("#filetab").css('display')=='none'?0:$("#filetab").width();
    var w3=w-w1-w2;
    $("#tabstd").css("width",100*(w1/w)+"%");
    $("#tabs").css("width",100*(w1/w)-1+"%");
    $("#tabs, #queries, #last_result, .main_restr").css("height","auto");
    $("#queries, #last_result, .main_restr").css("width",100*(w1/w)-4+"%");
    $("#mainwrappertd").css("width",100*(w3/w)+"%");
    $("#mainwrapper").css("width",100*(w3/w)-1+"%");
    $("#filetabtd").css("width",100*(w2/w)+"%");
    if($("#filetab").css('display')!='none') $("#filetab, .main_restr2").css("width",100*(w2/w)+"%");
} });
$("#filetab").resizable({ handles: "w", alsoResize: ".main_restr2", resize: function(event, ui){
    var w=$(window).width();
    var w1=$("#tabs").css('display')=='none'?0:$("#tabs").width()+w/100;
    var w2=$("#filetab").css('display')=='none'?0:$("#filetab").width();
    var w3=w-w1-w2;
    $("#tabstd").css("width",100*(w1/w)+"%");
    if($("#tabs").css('display')!='none') $("#tabs").css("width",100*(w1/w)-1+"%");
    $("#queries, #last_result, .main_restr").css("width",100*(w1/w)-4+"%");
    $("#mainwrappertd").css("width",100*(w3/w)+"%");
    $("#mainwrapper").css("width",100*(w3/w)-1+"%");
    $("#filetabtd").css("width",100*(w2/w)+"%");
    $("#filetab, .main_restr2").css("left","");
    $("#filetab, .main_restr2").css("height","");
    $("#filetab, .main_restr2").css("width",100*(w2/w)+"%");
} });

})
</script>
</body>
</html>

